<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å°é­šBBSç³»çµ± V2.0.0 - å¤šäººé€£ç·šç‰ˆ</title>
<style>
  body { background: black; color: #00ff00; font-family: 'Courier New', monospace; line-height: 1.5; }
  input, button, select { background: black; color: #00ff00; border: 1px solid #00ff00; padding: 5px; margin: 2px; }
  button:hover { background: #004400; cursor: pointer; }
  .panel { border: 1px solid #00ff00; padding: 10px; margin: 10px 0; }
  .post-item { border-bottom: 1px dashed #005500; padding: 5px 0; }
  .timestamp { color: #888; font-size: 0.8em; }
  .user-tag { color: #ffff00; font-weight: bold; }
  #status { color: yellow; margin-bottom: 10px; }
</style>
</head>
<body>

<h2>=== å°é­š BBS ç³»çµ± V2.0.0 (Cloud) ===</h2>
<div id="status">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

<div id="auth" class="panel">
  <input id="username" placeholder="å¸³è™Ÿ">
  <input id="password" type="password" placeholder="å¯†ç¢¼ (ç°¡æ˜“é©—è­‰)">
  <button onclick="login()">ç™»å…¥ / è¨»å†Š</button>
  <p style="font-size: 0.8em;">* æç¤ºï¼šæ­¤ç‰ˆæœ¬ä½¿ç”¨ Firebase é›²ç«¯è³‡æ–™åº«å¯¦ç¾å¤šäººå³æ™‚åŒæ­¥ã€‚</p>
</div>

<div id="bbs" style="display:none">
  ğŸ‘¤ ç•¶å‰åœ¨ç·šï¼š<span id="currentUser" class="user-tag"></span>
  <button onclick="logout()">ç™»å‡º</button>

  <div class="panel">
    åˆ‡æ›çœ‹æ¿ï¼š
    <select id="boardSelect" onchange="switchBoard()">
      <option value="Minecraft">Minecraft</option>
      <option value="èŠå¤©">èŠå¤©</option>
      <option value="å…¬å‘Š">å…¬å‘Š</option>
      <option value="é­šæ¿">é­šæ¿</option>
    </select>
  </div>

  <div class="panel">
    <input id="msg" style="width: 70%;" placeholder="è¼¸å…¥è¨Šæ¯...">
    <button onclick="post()">ç™¼é€ (Enter)</button>
  </div>

  <div class="panel">
    <div id="posts">æ­£åœ¨è¼‰å…¥é›²ç«¯è¨Šæ¯...</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, get, child } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // --- è«‹å°‡ä¸‹æ–¹çš„é…ç½®æ›¿æ›æˆä½ è‡ªå·± Firebase å°ˆæ¡ˆçš„é…ç½® ---
  const firebaseConfig = {
    apiKey: "ä½ çš„API_KEY",
    authDomain: "ä½ çš„PROJECT_ID.firebaseapp.com",
    databaseURL: "https://ä½ çš„PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "ä½ çš„PROJECT_ID",
    storageBucket: "ä½ çš„PROJECT_ID.appspot.com",
    messagingSenderId: "ä½ çš„SENDER_ID",
    appId: "ä½ çš„APP_ID"
  };

  // åˆå§‹åŒ– Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentUser = null;
  let currentBoard = "Minecraft";

  // å°‡å‡½æ•¸æ›è¼‰åˆ° windowï¼Œè®“ HTML çš„ onclick å¯ä»¥å‘¼å«
  window.login = async () => {
    const u = document.getElementById("username").value.trim();
    const p = document.getElementById("password").value.trim();
    if (!u || !p) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

    const userRef = ref(db, 'users/' + u);
    const snapshot = await get(userRef);
    
    if (snapshot.exists()) {
      if (snapshot.val().password !== p) {
        return alert("å¯†ç¢¼éŒ¯èª¤ï¼");
      }
    } else {
      // è¨»å†Šæ–°å¸³è™Ÿ
      await set(userRef, { password: p });
      alert("æ–°ç”¨æˆ¶è¨»å†ŠæˆåŠŸï¼");
    }

    currentUser = u;
    document.getElementById("auth").style.display = "none";
    document.getElementById("bbs").style.display = "block";
    document.getElementById("currentUser").innerText = u;
    document.getElementById("status").innerText = "é€£ç·šç‹€æ…‹ï¼šé›²ç«¯åŒæ­¥ä¸­";
    switchBoard();
  };

  window.logout = () => {
    location.reload(); // ç°¡å–®ç²—æš´çš„ç™»å‡º
  };

  window.switchBoard = () => {
    currentBoard = document.getElementById("boardSelect").value;
    loadPosts();
  };

  // æ ¸å¿ƒåŠŸèƒ½ï¼šç›£è½é›²ç«¯è³‡æ–™è®Šå‹• (å¤šäººé€£ç·šé—œéµ)
  function loadPosts() {
    const boardRef = ref(db, 'boards/' + currentBoard);
    
    // Firebase çš„ onValue æœƒåœ¨è³‡æ–™æ›´æ–°æ™‚è‡ªå‹•è§¸ç™¼
    onValue(boardRef, (snapshot) => {
      const postsDiv = document.getElementById("posts");
      postsDiv.innerHTML = "";
      const data = snapshot.val();
      
      if (!data) {
        postsDiv.innerHTML = "ç›®å‰å°šç„¡è¨Šæ¯ï¼Œä¾†æ¶é ­é¦™å§ï¼";
        return;
      }

      // å°‡è³‡æ–™è½‰æ›æˆé™£åˆ—ä¸¦æ’åºï¼ˆFirebase Key æ˜¯æŒ‰æ™‚é–“ç”Ÿæˆçš„ï¼‰
      Object.values(data).reverse().forEach(p => {
        const div = document.createElement('div');
        div.className = 'post-item';
        div.innerHTML = `<span class="timestamp">[${p.time}]</span> <span class="user-tag">${p.user}</span>: ${p.text}`;
        postsDiv.appendChild(div);
      });
    });
  }

  window.post = async () => {
    const msgInput = document.getElementById("msg");
    const text = msgInput.value.trim();
    if (!text) return;

    const boardRef = ref(db, 'boards/' + currentBoard);
    await push(boardRef, {
      user: currentUser,
      text: text,
      time: new Date().toLocaleTimeString()
    });

    msgInput.value = "";
  };

  // ç›£è½ Enter éµ
  document.getElementById("msg").addEventListener("keypress", (e) => {
    if (e.key === "Enter") window.post();
  });

  document.getElementById("status").innerText = "é€£ç·šç‹€æ…‹ï¼šæº–å‚™å°±ç·’";
</script>

</body>
</html>

